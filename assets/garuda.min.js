(function(b,a){a.Garuda={configInit:function(){if(b("#institute").val()!=""){this.getConfig()}},configOpenSelected:function(){b('input[type="checkbox"].selector:checked').parents("li").children('input[type="checkbox"].tree').attr("checked",true);b("span.actions a.all").each(function(){b(this).on("click",function(){b(this).parent().siblings("ul").children("li").children('input[type="checkbox"].selector').attr("checked",true)})});b("span.actions a.none").each(function(){b(this).on("click",function(){b(this).parent().siblings("ul").children("li").children('input[type="checkbox"].selector').attr("checked",false)})})},getConfig:function(){var c=b("#institute").data("update-url").split("?");var d=c[0]+"/"+encodeURIComponent(b("#institute").val());if(c[1]!=""){d+="?"+c[1]}b("#config").html(b("<img>").attr("src",a.ASSETS_URL+"images/ajax_indicator_small.gif"));b("#config").load(d)},uploadFromInput:function(c,d){a.Garuda.uploadFiles(c.files,d);jQuery(c).val("")},fileIDQueue:1,uploadFiles:function(g,e){for(var d=0;d<g.length;d++){var c=new FormData();c.append("file",g[d],g[d].name);var f=b("#"+e+"-statusbar-container .statusbar").first().clone().show();f.appendTo("#"+e+"-statusbar-container");c.append("message_id",b("#provisional-id").val());a.Garuda.uploadFile(c,f,e)}},uploadFile:function(c,e,d){b.ajax({xhr:function(){var f=b.ajaxSettings.xhr();if(f.upload){f.upload.addEventListener("progress",function(j){var i=0;var g=j.loaded||j.position;var h=j.total;if(j.lengthComputable){i=Math.ceil(g/h*100)}e.find(".progress").css({"min-width":i+"%","max-width":i+"%"});e.find(".progresstext").text(i===100?b("#"+d+"-upload-finished").text():i+"%")},false)}return f},url:a.ABSOLUTE_URI_STUDIP+"plugins.php/garudaplugin/message/upload/"+d,type:"POST",contentType:false,processData:false,cache:false,data:c,dataType:"json"}).done(function(g){e.find(".progress").css({"min-width":"100%","max-width":"100%"});var f=b("#"+d+" .files > .file").first().clone();f.on("click",function(){a.Garuda.removeFile(f)});f.find(".name").text(g.name);if(g.size<1024){f.find(".size").text(g.size+"B")}if(g.size>1024&&g.size<1024*1024){f.find(".size").text(Math.floor(g.size/1024)+"KB")}if(g.size>1024*1024&&g.size<1024*1024*1024){f.find(".size").text(Math.floor(g.size/1024/1024)+"MB")}if(g.size>1024*1024*1024){f.find(".size").text(Math.floor(g.size/1024/1024/1024)+"GB")}f.find(".icon").html(g.icon);f.data("document-id",g.document_id);f.appendTo("#"+d+" .files");f.fadeIn(300);e.find(".progresstext").text(b("#"+d+"-upload-received-data").text());e.delay(1000).fadeOut(300,function(){b(this).remove()})}).fail(function(i,f,h){var g=i.responseJSON.error;e.find(".progress").addClass("progress-error").attr("title",g);e.find(".progresstext").html(g);e.on("click",function(){b(this).fadeOut(300,function(){b(this).remove()})})})},removeFile:function(c){b.ajax({url:a.ABSOLUTE_URI_STUDIP+"plugins.php/garudaplugin/message/delete_file",data:{document_id:c.closest("li").data("document-id"),message_id:c.closest("form").find("input[name=message_id]").val()},type:"POST"});c.closest("li").fadeOut(300,function(){c.remove()})},init:function(){if(b('input[name="sendto"]:checked').val()=="all"||b('input[name="sendto"]:checked').val()=="courses"||b('input[name="sendto"]:checked').val()=="list"){b('button[name="add_filter"]').addClass("hidden-js")}b('input[name="sendto"]').on("click",function(){var h=b(".filtertext").data("text-src").split("?");if(b('input[name="sendto"]:checked').val()=="courses"){var i=h[0]+"/sendto_courses"}else{var i=h[0]+"/sendto_all"}if(h[1]!=""){i+="?"+h[1]}b(".filtertext").load(i);b(".userfilter").remove();if(b('input[name="sendto"]:checked').val()!="all"&&b('input[name="sendto"]:checked').val()!="courses"&&b('input[name="sendto"]:checked').val()!="list"){b('button[name="add_filter"]').removeClass("hidden-js")}else{b('button[name="add_filter"]').addClass("hidden-js")}if(b('input[name="sendto"]:checked').val()=="list"){b("#reclist").css("display","block");b("#reclist textarea").attr("disabled",false);b("span.filtertext").addClass("hidden-js")}else{b("#reclist").css("display","none");b("#reclist textarea").attr("disabled",true);b("span.filtertext").removeClass("hidden-js")}if(b('input[name="sendto"]:checked').val()=="courses"){b("div#garuda-coursesearch").removeClass("hidden-js")}else{b("div#garuda-coursesearch").addClass("hidden-js")}});b('input[name="exclude"]').on("click",function(){if(b(this).prop("checked")){b("#excludelist").css("display","block");b('textarea[name="excludelist"]').attr("disabled",false)}else{b("#excludelist").css("display","none");b('textarea[name="excludelist"]').attr("disabled",true)}});b('input[name="use_tokens"]').on("click",function(h){b("section.use-tokens").toggleClass("hidden-js");b("#tokens li.file:not(:first)").each(function(){a.Garuda.removeFile(b(this))})});b("a.remove-file").on("click",function(h){a.Garuda.removeFile(b(h.target))});var f=b("#garuda-markers");var d=b("#garuda-add-marker");f.children("select").on("change",function(){var h=b(this).children("option:selected");b("#garuda-marker-description").html(h.data("description"));if(h.attr("value")!=""){d.removeClass("hidden-js")}else{d.addClass("hidden-js")}});if(a.wysiwyg_enabled&&CKEDITOR.instances.length>0){var g=b('textarea[name="message"]').attr("id");CKEDITOR.instances[g].on("instanceReady",function(){f.insertAfter(b("div.cktoolbar"))});d.on("click",function(){CKEDITOR.instances[g].insertText(b("#garuda-markers select option:selected").attr("value"));return false})}else{f.addClass("no-wysiwyg");f.insertAfter("div.buttons");d.on("click",function(){f.parent().children("textarea").insertAtCaret(b("#garuda-markers select option:selected").attr("value"));return false})}b('input[name="send_at_date"]').on("click",function(h){b("section.send_date").toggleClass("hidden-js")});b('input[name="send_date"]').datetimepicker();b(".userfilter_actions a.delete").on("click",function(m){m.preventDefault();var k=b(this).parents(".userfilter");var i=k.parent();k.remove();if(i.children(".userfilter").length==0){var l=i.children(".filtertext");var h=l.data("text-src").split("?");var j=h[0]+"/sendto_all";if(h[1]!=""){j+="?"+h[1]}l.html(b("<img>").attr("src",a.ASSETS_URL+"images/ajax_indicator_small.gif"));l.load(j)}});if(b('input[name="sendto"]:checked').val()!="list"){b("#reclist").css("display","none");b("#reclist textarea").attr("disabled",true)}if(!b('input[name="exclude"]').attr("checked")){b("#excludelist").css("display","none");b('textarea[name="excludelist]').attr("disabled",true)}if(!a.wysiwyg_enabled||CKEDITOR.instances.length==0){b('textarea[name="message"]').typing({stop:function(){var h=b('textarea[name="message"]').data("preview-url").split("?");h=h[0];b("#message_preview_text").load(h,{text:encodeURIComponent(b('textarea[name="message"]').val())})},delay:500});var e=b('textarea[name="message"]').width();b("#message_preview_text").width(e);b("#message_preview_text").css("max-width",e);var c=b('textarea[name="message"]').height();b("#message_preview").css("left",e+30)}},initFilter:function(){b("#add_field").on("click",function(c){c.preventDefault();var d=b(".filterfield").first().clone();d.children(".fieldconfig").empty();d.children("select").val("");b("#filterfields").append(d)})},initField:function(){b('select[name="value[]"] option').each(function(){var c=b(this).prev();if(b(this).attr("value").indexOf("_children")!=-1){c.attr("class","fac");b(this).attr("class","fac_all")}if(c.attr("class")=="fac_all"||c.attr("class")=="inst"){b(this).attr("class","inst")}})},initRecipientView:function(){b("li.degree label").on("click",function(e){var c=b(this).children("img").first();var d=c.data("toggle-icon");c.data("toggle-icon",c.attr("src"));c.attr("src",d)});b("li.faculty label").on("click",function(e){var c=b(this).children("img").first();var d=c.data("toggle-icon");c.data("toggle-icon",c.attr("src"));c.attr("src",d)})},getFieldConfig:function(h){var i=b(h).parents(".filterfield");var e=i.data("relation");if(e!=""){var d=encodeURIComponent(b(h).siblings('select[name="compare_operator[]"]').val());var l=encodeURIComponent(b(h).val());var k=b("#"+e);var f=b(h).parent().data("update-url").split("?");var c=f[0]+"/"+e;var j=k.find('select[name="compare_operator[]"]').val();var g=k.find('select[name="value[]"]').val();c+="/"+d+"/"+l;if(f[1]!=""){c+="?"+f[1]}k.children(".fieldconfig").html(b("<img>").attr("src",a.ASSETS_URL+"images/ajax_indicator_small.gif"));k.children(".fieldconfig").load(c,function(){k.children(".fieldconfig").find('option[value="'+j+'"]').attr("selected",true);k.children(".fieldconfig").find('option[value="'+g+'"]').attr("selected",true)})}},getFilterConfig:function(f){var g="";var e="";var c=b(f).data("config-url").split("?");var d=c[0]+"/"+encodeURIComponent(b(f).val());if(c[1]!=""){d+="?"+c[1]}b(f).siblings(".fieldconfig").html(b("<img>").attr("src",a.ASSETS_URL+"images/ajax_indicator_small.gif"));b(f).siblings(".fieldconfig").load(d)},removeFilter:function(e){b(e).parents(".userfilter").remove();var g=b(".filtertext");var f=b(".userfilter").length;var c=g.data("text-src").split("?");if(f==0){var d=c[0]+"/sendto_all";if(c[1]!=""){d+="?"+c[1]}}else{if(f==1){var d=c[0]+"/sendto_filtered/true";if(c[1]!=""){d+="?"+c[1]}}else{var d=c[0]+"/sendto_filtered"+c[1];if(c[1]!=""){d+="?"+c[1]}}}g.html(b("<img>").attr("src",a.ASSETS_URL+"images/ajax_indicator_small.gif"));g.load(d);return false},replaceSender:function(e,c){var d=b("<div>").html(c).text();b("input#garuda-senderid").attr("value",e);b("span#garuda-sendername").html("("+d+")").removeClass("hidden-js");return false},addCourse:function(h,d){var f=b("<div>").html(d).text();var e=b("ul#garuda-courses");if(e.children("li."+h).length==0){var g=b("<li>").addClass(h).html(f);var c=b("<input>").attr("type","hidden").attr("name","courses[]").attr("value",h);g.append(c);e.append(g)}},addCC:function(h,d){var f=b("<div>").html(d).text();var e=b("ul#garuda-cc");if(e.children("li."+h).length==0){var g=b("<li>").addClass(h).html(f);var c=b("<input>").attr("type","hidden").attr("name","cc[]").attr("value",h);g.append(c);e.append(g)}}};b(document).ready(function(){b("span.garuda-more a, span.garuda-messagetext a").on("click",function(c){b(c.target).closest("span").toggleClass("hidden-js");b(c.target).closest("span").siblings("span").toggleClass("hidden-js");return false});b('input[type="radio"].garuda-sender-config').on("click",function(c){if(b(this).attr("value")=="person"){b("#garuda-sender-choose-person").removeClass("hidden-js")}else{b("#garuda-sender-choose-person").addClass("hidden-js");b("span#garuda-sendername").addClass("hidden-js")}});if(b("form.garuda-js-init").length>0){a.Garuda.init()}if(b('fieldset[name="database"]').length>0){b('input[name="enable"]').on("click",function(c){if(b('input[name="enable"]').is(":checked")){b('fieldset[name="database"]').removeClass("hidden-js");b('fieldset[name="tableinfo"]').removeClass("hidden-js");if(b('select[name="dbtype"]').children("option:selected").val()=="informix"){b('fieldset[name="additional"]').removeClass("hidden-js")}}else{b('fieldset[name="database"]').addClass("hidden-js");b('fieldset[name="tableinfo"]').addClass("hidden-js");b('fieldset[name="additional"]').addClass("hidden-js")}});b('select[name="dbtype"]').on("change",function(c){if(b(this).children("option:selected").val()=="informix"){b('fieldset[name="additional"]').removeClass("hidden-js")}else{b('fieldset[name="additional"]').addClass("hidden-js")}})}});b(document).on("dialog-update",function(c){if(b("form.garuda-js-init").length>0){a.Garuda.init()}})}(jQuery,STUDIP));